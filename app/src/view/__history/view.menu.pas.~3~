unit view.menu;

interface

{$DEFINE GERADOR_FORTES_REPORT}
{.$DEFINE GERADOR_FAST_REPORT}
uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,System.DateUtils,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs, Skia,System.JSON,
  FMX.Layouts, FMX.Skia, FMX.Objects,  uFancyDialog, System.Net.URLClient,
  System.Generics.Collections, System.Net.HttpClientComponent, System.Net.HttpClient, IdHTTP,
  FMX.Effects, uGosBase, uGosStandard, ACBrUtil, ACBrBase, controller.log,
  FMX.Memo.Types, FMX.Controls.Presentation, ACBrBoletoConversao, Windows,
  FMX.ScrollBox, FMX.Memo, ACBrPosPrinter, ACBrBoleto
  {$IFDEF GERADOR_FORTES_REPORT},ACBrBoletoFCFortesFr, FMX.ListBox{$ENDIF}
  {$IFDEF GERADOR_FAST_REPORT},ACBrBoletoFCFR, frxClass{$ENDIF};

type
  TfrmMenu = class(TForm)
    ALRectangle1: TRectangle;
    Layout1: TLayout;
    Layout3: TLayout;
    Layout2: TLayout;
    lblTitutlo: TSkLabel;
    lblSubtitulo: TSkLabel;
    Layout4: TLayout;
    Layout5: TLayout;
    Layout6: TLayout;
    btnSair: TGosButtonView;
    SkSvg3: TSkSvg;
    btnVoltar: TGosButtonView;
    SkSvg4: TSkSvg;
    Layout7: TLayout;
    SkLabel6: TSkLabel;
    Memo1: TMemo;
    skloading: TSkAnimatedImage;
    lbMenu: TListBox;
    ItemBoleto: TListBoxItem;
    ItemFatura: TListBoxItem;
    ItemExtrato: TListBoxItem;
    ItemLimite: TListBoxItem;
    ItemSeguro: TListBoxItem;
    ItemEmprestimo: TListBoxItem;
    recImprimirBoleto: TRectangle;
    SkSvg1: TSkSvg;
    SkLabel1: TSkLabel;
    Layout45: TLayout;
    SkSvg15: TSkSvg;
    recPagarFatura: TRectangle;
    SkSvg5: TSkSvg;
    SkLabel3: TSkLabel;
    Layout8: TLayout;
    SkSvg9: TSkSvg;
    recExtratoFatura: TRectangle;
    SkSvg2: TSkSvg;
    SkLabel2: TSkLabel;
    Layout9: TLayout;
    SkSvg10: TSkSvg;
    recEmprestimo: TRectangle;
    SkSvg7: TSkSvg;
    SkLabel5: TSkLabel;
    Layout10: TLayout;
    SkSvg11: TSkSvg;
    recLimite: TRectangle;
    SkSvg6: TSkSvg;
    SkLabel4: TSkLabel;
    Layout12: TLayout;
    SkSvg13: TSkSvg;
    recSeguro: TRectangle;
    SkSvg8: TSkSvg;
    SkLabel7: TSkLabel;
    Layout11: TLayout;
    SkSvg12: TSkSvg;
    lylLoading: TLayout;
    Layout13: TLayout;
    lblTituloLoading: TSkLabel;
    lblSubtituloLoading: TSkLabel;
    SkAnimatedImage1: TSkAnimatedImage;
    recLoading: TRectangle;
    procedure recImprimirBoletoClick(Sender: TObject);
    procedure btnSairClick(Sender: TObject);
    procedure btnVoltarClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure recPagarFaturaClick(Sender: TObject);
    procedure recExtratoFaturaClick(Sender: TObject);
    procedure recLimiteClick(Sender: TObject);
    procedure recEmprestimoClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure recSeguroClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
  private
    FMSG       : TFancyDialog;
    FCabecalho : TStringList;
    FRodape   : TStringList;
    FIdAccount : string;
    FToken     : string;
    FIDProduct : string;
    FCPF       : string;
    FNumCartao : string;
    FIDCartao  : string;
    FDeslogar  : Boolean;
    FjsonBoleto: TJSONObject;
    FACBrBoleto : TACBrBoleto;
  {$IFDEF GERADOR_FORTES_REPORT}FACBrBoletoFCRL   : TACBrBoletoFCFortes;{$ENDIF}
  {$IFDEF GERADOR_FAST_REPORT}FACBrBoletoFCFR   := TACBrBoletoFCFR;{$ENDIF}
    function ConsultaLimite(AIdAccount:string; out AjsonRetorno: TJSONObject) :Boolean;
    function GerarBoleto(AIdAccount: string; out AResult: TJSONObject): boolean;
    function CompletaString(texto, Caractere: string; Tamanho: Integer): string;
    function ConsultaFatura(AIdAccount:string; out AJsonFatura: TJSONArray): Boolean;
    procedure GerarTitulo(AJsonBoleto: TJSONObject);
    function MontaCupom: Boolean;
    { Private declarations }
  public
    { Public declarations }
    procedure carregaTela(AJson: TJSONObject);
  end;

var
  frmMenu: TfrmMenu;

implementation

{$R *.fmx}

uses uFormataCampos, view.CPF, view.SelecaoCartao,
  view.Principal, view.Limite,
  uConnection, uToken, Notificacao, view.PagarFatura, uAguarde, view.Emprestimo,
  view.ExtratoFatura, LogSQLite, controller.impressao, view.Seguros;

procedure TfrmMenu.carregaTela(AJson: TJSONObject);
begin
  FIDCartao := Ajson.getValue<String>('IDCard');
  FIdAccount:= Ajson.getValue<String>('IDAccount');
  FCPF := Ajson.getValue<String>('CPF');
  FIDProduct := Ajson.getValue<String>('IDProduct');
  lblTitutlo.Text := 'Oi, '+ copy(Ajson.GetValue<String>('Nome'),1,pos(' ',Ajson.GetValue<String>('Nome'))-1)+'!';
  FNumCartao:= Ajson.getValue<String>('NumCard');
end;
procedure TfrmMenu.recPagarFaturaClick(Sender: TObject);
var
  LjsonFatura: TJSONArray;
begin
  {$REGION 'Pagar Fatura'}
//  TLoading.Show(frmMenu,'Aguarde, Carregando faturas...');
//  skloading.Visible := true;
//  skloading.Animation.Start;
  recLoading.Visible := true;
  lylLoading.Visible := true;
  lblTituloLoading.Text := 'Aguarde';
  lblSubtituloLoading.Text := 'Estamos consultando faturas!';
  TThread.CreateAnonymousThread(
  procedure
  begin
    try
      TThread.Synchronize(nil,
      procedure
      begin
        if not Assigned(frmPagarFatura) then
          Application.CreateForm(TfrmPagarFatura, frmPagarFatura);
      end);

      log('Iniciou consulta fatura: '+datetimetostr(now));
      if FToken.IsEmpty  then
      begin
        if not ConsultaToken(FURL+'/v1/authentication', FToken) then
        begin
          TLoading.ToastMessage(frmMenu,'Erro ao buscar Token',5,TAlignLayout.MostRight);
          exit;
        end;
      end;

      if not ConsultaFatura(FIdAccount,LjsonFatura) then
       begin
        TLoading.ToastMessage(frmMenu,'Erro ao consultar faturas para esta conta]1',5,TAlignLayout.MostRight);
        exit;
      end;

      TThread.Synchronize(nil,
      procedure
      begin
        frmPagarFatura.Show;
      end);

      frmPagarFatura.carregaTela(LjsonFatura,FIdAccount, FIDProduct, FCPF);
      log('Finalizou lista fatura: '+datetimetostr(now));

    finally
      TThread.Synchronize(nil,
      procedure
      begin
//        TAguarde.Hide;
//        skloading.Animation.stop;
//        skloading.Visible := false;
        recLoading.Visible := false;
        lylLoading.Visible := false;
      end);
    end;
  end).Start;
  {$ENDREGION}
end;

procedure TfrmMenu.recSeguroClick(Sender: TObject);
begin
  {$REGION 'Seguros'}

//  TLoading.ToastMessage(frmMenu,'Em fase de desenvolvimento',5,TAlignLayout.MostRight);
//  skloading.Visible := true;
//  skloading.Animation.start;
  recLoading.Visible := true;
  lylLoading.Visible := true;
  lblTituloLoading.Text := 'Aguarde';
  lblSubtituloLoading.Text := 'Estamos processando as informações';
  TThread.CreateAnonymousThread(
  procedure
  begin
    try
      TThread.Synchronize(nil,
      procedure
      begin
        if not Assigned(frmSeguros) then
          Application.CreateForm(TfrmSeguros, frmSeguros);
      end);
      if FToken.IsEmpty  then
      begin
        if not ConsultaToken(FURL+'/v1/authentication', FToken) then
        begin
          exit;
        end;
      end;

      TThread.Synchronize(nil,
      procedure
      begin
        frmSeguros.Show;
      end);

      frmSeguros.carregaTela(FCPF);
    finally
      TThread.Synchronize(nil,
      procedure
      begin
//        skloading.Animation.stop;
//        skloading.Visible := false;
        recLoading.Visible := false;
        lylLoading.Visible := false;
      end);
    end;
  end).Start;
  {$ENDREGION}
end;

procedure TfrmMenu.btnSairClick(Sender: TObject);
begin
  FMsg.Show(TIconDialog.Warning,'Atenção','Confirma fechar seu acesso?','SIM',
  procedure
  begin
    TThread.CreateAnonymousThread(
    procedure
    begin
      try
        TThread.Synchronize(nil,
        procedure
        begin
          if not Assigned(frmPrincipal) then
            Application.CreateForm(TfrmPrincipal, frmPrincipal);
        end);

        TThread.Synchronize(nil,
        procedure
        begin
          frmPrincipal.Show;
        end);

      finally
//        TThread.Synchronize(nil,
//        procedure
//        begin
//          frmSelecaoCartao.close;
//          frmMenu.Close;
//        end);
      end;
    end).Start;
  end,'NÃO',
  procedure
  begin
  end);
end;
procedure TfrmMenu.btnVoltarClick(Sender: TObject);
begin
  TThread.CreateAnonymousThread(
  procedure
  begin
    try
      TThread.Synchronize(nil,
      procedure
      begin
        if not Assigned(frmSelecaoCartao) then
          Application.CreateForm(TfrmSelecaoCartao, frmSelecaoCartao);
      end);

      TThread.Synchronize(nil,
      procedure
      begin
        frmSelecaoCartao.Show;
      end);

    finally
//      TThread.Synchronize(nil,
//      procedure
//      begin
//        frmMenu.close;
//      end);
    end;
  end).Start;
end;

procedure TfrmMenu.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action := TCloseAction.caFree;
  frmMenu := nil;
end;

procedure TfrmMenu.FormCreate(Sender: TObject);
begin
  FMsg := TFancyDialog.Create(self);
  FMsg := TFancyDialog.Create(self);
//  Layout2.Height :=   frmMenu.Height ;
//  Layout2.Width :=   frmMenu.Width * 0.58;
//  Layout4.Height :=   frmMenu.Height * 0.8 ;
//  Layout4.Width :=   frmMenu.Width * 0.58;
  FDeslogar := false;
  FACBrBoleto := TACBrBoleto.Create(Self);

  {$IFDEF GERADOR_FORTES_REPORT}
    FACBrBoletoFCRL   := TACBrBoletoFCFortes.Create(FACBrBoleto);
  {$ENDIF}

  {$IFDEF GERADOR_FAST_REPORT}
    FACBrBoletoFCFR   := TACBrBoletoFCFR.Create(FACBrBoleto);
  {$ENDIF}

  SkLabel6.text := 'Sistema de Teste - Versão '+frmPrincipal.FVersion;
end;

procedure TfrmMenu.FormDestroy(Sender: TObject);
begin
  FreeAndNil(FMSG);
  FreeAndNil(FACBrBoletoFCRL);
//  FreeAndNil(FACBrBoletoFCFR);
  FreeAndNil(FACBrBoleto);
end;

procedure TfrmMenu.FormShow(Sender: TObject);
begin
  ItemBoleto.Visible := frmPrincipal.FMenuBoleto;
  ItemFatura.Visible := frmPrincipal.FMenuFatura;
  ItemExtrato.Visible := frmPrincipal.FMenuExtrato;
  ItemLimite.Visible := frmPrincipal.FMenuLimite;
  ItemSeguro.Visible := frmPrincipal.FMenuSeguro;
  ItemEmprestimo.Visible := frmPrincipal.FMenuEmprestimo;
end;

procedure TfrmMenu.recEmprestimoClick(Sender: TObject);
begin
  {$REGION 'Emprestimo Pessoal'}
  if ( not frmPrincipal.FSmEmprestimoSimular) and (not frmPrincipal.FSmEmprestimoExtrato) then
  begin
    TLoading.ToastMessage(frmMenu,'Opção Desativada, contatar ao administrador!',5,TAlignLayout.MostRight);
    exit;
  end;

 TThread.CreateAnonymousThread(
  procedure
  begin
    try
      TThread.Synchronize(nil,
      procedure
      begin
        if not Assigned(frmEmprestimo) then
          Application.CreateForm(TfrmEmprestimo, frmEmprestimo);
      end);

      frmEmprestimo.carregaTela(Fcpf);

      TThread.Synchronize(nil,
      procedure
      begin
        frmEmprestimo.Show;
      end);

    finally

    end;
  end).Start;

  {$ENDREGION}
end;

procedure TfrmMenu.recExtratoFaturaClick(Sender: TObject);
begin
  {$REGION 'Extrato Fatura'}
//  TLoading.Show(frmMenu,'Aguarde..');
  TThread.CreateAnonymousThread(
  procedure
  begin
    try
      TThread.Synchronize(nil,
      procedure
      begin
        if not Assigned(frmExtratoFatura) then
          Application.CreateForm(TfrmExtratoFatura, frmExtratoFatura);
      end);

      TThread.Synchronize(nil,
      procedure
      begin
        frmExtratoFatura.actTabLoginSenha.Execute;
        frmExtratoFatura.Show;
      end);

      frmExtratoFatura.carregaTela(FIdAccount,FCPF,FIDCartao);
    finally
//      TThread.Synchronize(nil,
//      procedure
//      begin
//        TLoading.Hide;
//      end);
    end;
  end).Start;


  {$ENDREGION}
end;

procedure TfrmMenu.recImprimirBoletoClick(Sender: TObject);
begin
  {$REGION 'Boleto'}
//  TLoading.Show(frmMenu,'Aguarde...');
//  skloading.Visible := true;
//  skloading.Animation.Start;
  recLoading.Visible := true;
  lylLoading.Visible := true;
  lblTituloLoading.Text := 'Imprimir Boleto';
  lblSubtituloLoading.Text := 'Aguarde enquanto o boleto é impresso';
  TThread.CreateAnonymousThread(
  procedure
  begin
    try
      if FToken.IsEmpty  then
      begin
        if not ConsultaToken(FURL+'/v1/authentication', FToken) then
        begin
          TLoading.ToastMessage(frmMenu,'Erro ao buscar Token' ,5,TAlignLayout.MostRight);
          exit;
        end;
      end;

      GerarBoleto(FIdAccount,FjsonBoleto);

      if not MontaCupom then
      begin
        TLoading.ToastMessage(frmMenu,'Erro ao Imprimir Boleto' ,4,TAlignLayout.MostRight);
        exit;
      end
      else
      begin
        TLoading.ToastMessage(frmMenu,'Boleto Impresso com sucesso' ,4,TAlignLayout.MostRight);
      end;
    finally
      TThread.Synchronize(nil,
      procedure
      begin
//        skloading.Animation.stop;
//        skloading.Visible := false;
        recLoading.Visible := false;
        lylLoading.Visible := false;
//        TLoading.Hide;
      end)
    end;
  end).Start;


  {$ENDREGION}
end;

procedure TfrmMenu.recLimiteClick(Sender: TObject);
var
  FjsonRetorno : TJSONObject;
begin
  {$REGION 'Limite'}
//  TLoading.Show(frmMenu,'Aguarde...');
//  skloading.Visible := true;
//  skloading.Animation.Start;
  recLoading.Visible := true;
  lylLoading.Visible := true;
  lblTituloLoading.Text := 'Aguarde';
  lblSubtituloLoading.Text := 'Estamos consultando informação!';
  TThread.CreateAnonymousThread(
  procedure
  begin
    try
      TThread.Synchronize(nil,
      procedure
      begin
        if not Assigned(frmLimite) then
          Application.CreateForm(TfrmLimite, frmLimite);
      end);

      if FToken.IsEmpty  then
      begin
        if not ConsultaToken(FURL+'/v1/authentication', FToken) then
        begin
          exit;
        end;
      end;

      if not ConsultaLimite(FIdAccount, FjsonRetorno) then
        exit;

      TThread.Synchronize(nil,
      procedure
      begin
        frmLimite.Show;
      end);

      frmLimite.CarregaTela(FCPF, FjsonRetorno );

    finally
      TThread.Synchronize(nil,
      procedure
      begin
//        TLoading.Hide;
//        skloading.Animation.stop;
//        skloading.Visible := false;
        recLoading.Visible := false;
        lylLoading.Visible := false;
      end);
    end;
  end).Start;
  {$ENDREGION}
end;


function TfrmMenu.ConsultaLimite(AIdAccount:string; out AjsonRetorno: TJSONObject): Boolean;
var
  LConnection: TConnection;
  LResult: string;
begin
  LConnection:= TConnection.Create;
  try

    if LConnection.Get(FURL+'/v2/account/'+AIdAccount+'/limits/details',[], LResult, FToken) then
    begin
      result := true;
      AjsonRetorno := TJSONObject.ParseJSONValue(TEncoding.ASCII.GetBytes(LResult), 0) as TJSONObject;
    end
    else
    begin
      result := false;
      log('Erro ao consultar limite '+LResult);
    end;

  finally
    FreeAndNil(LConnection);
  end;
end;

function TfrmMenu.GerarBoleto(AIdAccount:string;Out AResult:TJSONObject): boolean;
var
  LConnection  : TConnection;
  LResult      : string;
  Ljson        : TJSONValue;
begin
  LConnection:= TConnection.Create;
  try

    if LConnection.Get(FURL+'/v1/account/'+AIdAccount+'/invoice-data',[], LResult, FToken) then
    begin
      AResult := TJSONObject.ParseJSONValue(TEncoding.ASCII.GetBytes(LResult), 0) as TJSONObject;
       if AResult.GetValue<string>('numeroDoDocumento','') = '' then
         result := false
      else
         result := true;
    end
    else
    begin
      Result := false;
      log('Erro: '+LResult)
    end;

  finally
    FreeAndNil(LConnection);
  end;
end;

function TfrmMenu.ConsultaFatura(AIdAccount:string; out AJsonFatura: TJSONArray): Boolean;
var
  LConnection: TConnection;
  LResult: string;
begin
  LConnection:= TConnection.Create;
  try
    try
      if LConnection.Get(FURL+'/v1/account/'+AIdAccount+'/invoices',[], LResult, FToken) then
      begin
        result := true;
        AJsonFatura := TJSONArray.ParseJSONValue(TEncoding.ASCII.GetBytes(LResult), 0) as TJSONArray;
      end
      else
      begin
        result := false;
        log('Erro: '+LResult)
      end;

    except on ex: exception do
      begin
        log('Erro: '+ ex.Message);
      end;

    end;

  finally
    FreeAndNil(LConnection);
  end;
end;

procedure TfrmMenu.GerarTitulo(AJsonBoleto: TJSONObject);
var
  LTitulo : TACBrTitulo;
  LIndex : Cardinal;
  LJson: TJSONValue;
  Banco : string;
  Banco1 : integer;
begin

  FACBrBoleto.ACBrBoletoFC := FACBrBoletoFCRL;
  FACBrBoletoFCRL.MostrarPreview := false;
  FACBrBoletoFCRL.MostrarSetup := false;
  FACBrBoletoFCRL.MostrarProgresso := false;
  FACBrBoletoFCRL.LayOut := lTermica80mm;
  FACBrBoletoFCRL.MargemSuperior :=-3;
  FACBrBoletoFCRL.MargemInferior :=0;
  FACBrBoletoFCRL.MargemEsquerda :=3;
  FACBrBoletoFCRL.MargemDireita  :=0;
  FACBrBoleto.ListadeBoletos.Clear;

  FACBrBoleto.Cedente.Nome := AJsonBoleto.GetValue<string>('nomeBeneficiario');
  FACBrBoleto.Cedente.CNPJCPF := AJsonBoleto.GetValue<string>('documentoBeneficiario');
  FACBrBoleto.Cedente.CodigoCedente := AJsonBoleto.GetValue<string>('codigoBeneficiario');
  FACBrBoleto.Cedente.Agencia := AJsonBoleto.GetValue<string>('agencia');
  FACBrBoleto.Cedente.AgenciaDigito := AJsonBoleto.GetValue<string>('digitoCodigoBeneficiario');
  FACBrBoleto.Cedente.Conta := AJsonBoleto.GetValue<string>('numeroConvenio');
  FACBrBoleto.Cedente.ContaDigito := AJsonBoleto.GetValue<string>('digitoCodigoBeneficiario');
  case strtoint(copy(AJsonBoleto.GetValue<string>('banco'),1,3)) of
     33,353,8 :FACBrBoleto.Banco.TipoCobranca := cobSantander;
     237      :FACBrBoleto.Banco.TipoCobranca := cobBradesco;
     001      :FACBrBoleto.Banco.TipoCobranca :=  cobBancoDoBrasil;
//     cobBancoDoBrasilAPI     : fBancoClass := TACBrBancoBrasil.create(Self);         {001}
//     cobBancoDoBrasilWS      : fBancoClass := TACBrBancoBrasil.create(Self);         {001}
//     cobBancoDoBrasilSICOOB  : fBancoClass := TACBrBancoBrasilSICOOB.Create(Self);   {001}
     003  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoDaAmazonia ;
     004  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoDoNordeste ;
     021  :FACBrBoleto.Banco.TipoCobranca :=  cobBanestes        ;
     041  :FACBrBoleto.Banco.TipoCobranca :=  cobBanrisul        ;
     070  :FACBrBoleto.Banco.TipoCobranca :=  cobBRB             ;
     091  :FACBrBoleto.Banco.TipoCobranca :=  cobUnicredRS       ;
     085  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoCECRED     ;
     097  :FACBrBoleto.Banco.TipoCobranca :=   cobCrediSIS       ;
     099  :FACBrBoleto.Banco.TipoCobranca :=  cobUniprime        ;
     104  :FACBrBoleto.Banco.TipoCobranca :=  cobCaixaEconomica  ;
  //     cobCaixaSicob           : fBancoClass := TACBrCaixaEconomicaSICOB.create(Self); {104}
     136  :FACBrBoleto.Banco.TipoCobranca :=  cobUnicredES       ;
     341  :FACBrBoleto.Banco.TipoCobranca :=  cobItau            ;
     389  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoMercantil  ;
     748  :FACBrBoleto.Banco.TipoCobranca :=  cobSicred          ;
     756  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoob         ;
     399  :FACBrBoleto.Banco.TipoCobranca :=  cobHSBC            ;
  //     cobBicBanco             : fBancoClass := TACBrBancoBic.create(Self);            {237}
  //     cobBradescoSICOOB       : fBancoClass := TAcbrBancoBradescoSICOOB.create(Self); {237}
     422  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoSafra      ;
  //     cobSafraBradesco        : fBancoClass := TACBrBancoSafraBradesco.Create(Self);  {422 + 237}
     047  :FACBrBoleto.Banco.TipoCobranca :=  cobBanese          ;
  //     cobBancoCresolSCRS      : fBancoClass := TACBrBancoCresolSCRS.create(Self);     {133 + 237}
     745  :FACBrBoleto.Banco.TipoCobranca :=  cobCitiBank        ;
     246  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoABCBrasil  ;
     084  :FACBrBoleto.Banco.TipoCobranca :=  cobUniprimeNortePR ;
  //     cobBancoPine            : fBancoClass := TACBrBancoPine.create(Self);
     643  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoPineBradesco;
     025  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoAlfa        ;
     133  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoCresol      ;
     274  :FACBrBoleto.Banco.TipoCobranca :=  cobMoneyPlus        ;
     336  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoC6          ;
     633  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoRendimento  ;
     077  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoInter       ;
     637  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoSofisaSantander ;
     218  :FACBrBoleto.Banco.TipoCobranca :=  cobBS2              ;
  //     cobPenseBankAPI          : fBancoClass := TACBrBancoPenseBank.Create(Self);
     208  :FACBrBoleto.Banco.TipoCobranca :=  cobBTGPactual          ;
     212  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoOriginal       ;
     655  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoVotorantim     ;
     174  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoPefisa         ;
     224  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoFibra          ;
  //   637  cobBancoSofisaItau      : fBancoClass := TACBrBancoSofisaItau.Create(Self);      {637}
     604  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoIndustrialBrasil;
     329  :FACBrBoleto.Banco.TipoCobranca :=  cobBancoQITechSCD       ;
  end;
  FACBrBoleto.Banco.CodigodeBarras:= AJsonBoleto.GetValue<string>('codigoDeBarras');
  FACBrBoleto.Banco.Linhadigitavel:= AJsonBoleto.GetValue<string>('linhaDigitavel');


  LTitulo := FACBrBoleto.CriarTituloNaLista;

  LTitulo.Vencimento        := IncMilliSecond(UnixDateDelta,AJsonBoleto.GetValue<Int64>('dataVencimento'));
  LTitulo.DataDocumento     := IncMilliSecond(UnixDateDelta,AJsonBoleto.GetValue<Int64>('dataDocumento'));
  LTitulo.NumeroDocumento   := AJsonBoleto.GetValue<string>('numeroDoDocumento');
  LTitulo.EspecieDoc        := AJsonBoleto.GetValue<string>('especieDoDocumento');
//  LTitulo.Aceite := atNao;

  LTitulo.DataProcessamento := IncMilliSecond(UnixDateDelta,AJsonBoleto.GetValue<Int64>('dataProcessamento'));
  LTitulo.Carteira          := AJsonBoleto.GetValue<string>('carteira');
  LTitulo.NossoNumero       := AJsonBoleto.GetValue<string>('nossoNumero');
  LTitulo.ValorDocumento    := AJsonBoleto.GetValue<double>('valorBoleto');
  LTitulo.Sacado.NomeSacado := AJsonBoleto.GetValue<string>('nomePagador');
  LTitulo.Sacado.CNPJCPF    := AJsonBoleto.GetValue<string>('documentoPagador');
  LTitulo.Sacado.Logradouro := AJsonBoleto.GetValue<string>('logradouroPagador');
  LTitulo.Sacado.Numero     := copy(AJsonBoleto.GetValue<string>('logradouroPagador'),Pos(', ',AJsonBoleto.GetValue<string>('logradouroPagador'))+2,length(AJsonBoleto.GetValue<string>('logradouroPagador')));
  LTitulo.Sacado.Bairro     := AJsonBoleto.GetValue<string>('bairroPagador');
  LTitulo.Sacado.Cidade     := AJsonBoleto.GetValue<string>('cidadePagador');
  LTitulo.Sacado.UF         := AJsonBoleto.GetValue<string>('ufPagador');
  LTitulo.Sacado.CEP        := AJsonBoleto.GetValue<string>('cepPagador');
  LTitulo.ValorAbatimento   := AJsonBoleto.GetValue<double>('valorBoleto');

  for LJson in  AJsonBoleto.GetValue<TJSONArray>('locaisDePagamento') do
  begin
    LTitulo.LocalPagamento    := LJson.value;
    break;
  end;

  LTitulo.ValorMoraJuros    := 0;
  LTitulo.ValorDesconto     := 0;
  LTitulo.TipoDesconto      := tdNaoConcederDesconto;
  LTitulo.PercentualMulta   := 0;
  for LJson in  AJsonBoleto.GetValue<TJSONArray>('instrucoes') do
    begin
      LTitulo.Mensagem.Text      := trim(LJson.value);
      break;
    end;

  LTitulo.QtdePagamentoParcial   := 1;
  LTitulo.TipoPagamento          := tpNao_Aceita_Valor_Divergente;
  LTitulo.PercentualMinPagamento := 0;
  LTitulo.PercentualMaxPagamento := 0;
  LTitulo.ValorMinPagamento      := 0;
  LTitulo.ValorMaxPagamento      := 0;
  LTitulo.Verso := false;


  for LIndex := 0 to Pred(FACBrBoleto.ListadeBoletos.Count) do
  begin
    FACBrBoleto.ACBrBoletoFC.CalcularNomeArquivoPDFIndividual := True;
    FACBrBoletoFCRL.PdfSenha := IntToStr(LIndex+1);

    FACBrBoleto.ACBrBoletoFC.GerarPDF(LIndex);
  end;
end;

function TfrmMenu.CompletaString(texto, Caractere: string; Tamanho: Integer): string;
begin
//  Result := Copy(texto, 1, Tamanho) + Repl(Caractere, (Tamanho - Length(texto)));
end;

function TfrmMenu.MontaCupom: Boolean;
var
  LImprimir: TImprimir;
  LImprimirRodape: TImprimir;
begin
  GerarTitulo(FjsonBoleto);

  if FACBrBoleto.ListadeBoletos.Count = 0 then
  begin
    Result:= false;
    exit;
  end;

  FCabecalho := TStringList.Create;
  FRodape := TStringList.Create;
  LImprimir := TImprimir.Create;
  LImprimirRodape := TImprimir.Create;
  try
    try
      log('populando componente');

      FCabecalho.Add('</zera>');
      FCabecalho.Add('</ce><e><n>'+'Cartao Calcard VISA'+'</n></e>');
      FCabecalho.Add('Fatura para pagamento');
      FCabecalho.Add('</zera>');
      FCabecalho.Add(now.ToString);
      FCabecalho.Add(' ');
      FCabecalho.Add('</ae>Titular     : '+FjsonBoleto.GetValue<string>('nomePagador'));
      FCabecalho.Add('Cartao      : '+FNumCartao);
      FCabecalho.Add('Vencimento  : '+IncMilliSecond(UnixDateDelta,FjsonBoleto.GetValue<Int64>('dataVencimento')).ToString);
      FCabecalho.Add(' ');
      FCabecalho.Add('</zera>Valor total para pagamento  :  '+'</ad>R$'+FormatFloatBr(msk9x2,FjsonBoleto.GetValue<double>('valorBoleto')));
      FCabecalho.Add('</zera>Valor minimo para pagamento :  '+'</ad>R$'+FormatFloatBr(msk9x2,FjsonBoleto.GetValue<double>('valorBoleto')));
      FCabecalho.Add('</zera></linha_simples>');

      log('mandando imprimir');
      LImprimir.Imprimir(FCabecalho);
      log('Imprimiu Cabeçalho');
      FACBrBoleto.Imprimir;

      log('Imprimiu Boleto');


    //  FRodape.Clear;
    //  FRodape.Add('</zera>');
    //  FRodape.Add('</linha_simples>');
    //  FRodape.Add('</ae>Calcard - www.calcard.com.br');
    //  FRodape.Add('SAC: 0800 653033.');
    //  FRodape.Add('</corte_total>');

    //  LImprimirRodape.Imprimir(FRodape);

      result:= true;

    except on ex: exception do
      begin
        result := false;
        log('Erro: '+ ex.Message);
      end;

    end;
  finally
    FreeAndNil(FCabecalho);
    FreeAndNil(FRodape);
    FreeAndNil(LImprimir);
    FreeAndNil(LImprimirRodape);
  end;
end;


end.
